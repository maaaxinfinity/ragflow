# FreeChat XState å¿«é€Ÿæµ‹è¯•æŒ‡å—

**æœ€åæ›´æ–°**: 2025-01-11  
**çŠ¶æ€**: âœ… å·²é›†æˆï¼Œå¯æµ‹è¯•

---

## ğŸ¯ æµ‹è¯•ç›®æ ‡

éªŒè¯Draftâ†’Activeè½¬æ¢æ—¶ï¼Œ**æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Œç•Œé¢ä¸åˆ·æ–°**ã€‚

---

## âœ… æµ‹è¯•æ­¥éª¤

### 1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
cd web
npm run dev
```

è®¿é—®: `http://localhost:8000/free-chat?user_id=test_user`

### 2. åŸºç¡€åŠŸèƒ½æµ‹è¯•

#### Test Case 1: é€‰æ‹©åŠ©æ‰‹åˆ›å»ºDraft

1. ç‚¹å‡»å·¦ä¾§"åŠ©æ‰‹"æ ‡ç­¾
2. é€‰æ‹©ä»»æ„ä¸€ä¸ªåŠ©æ‰‹å¡
3. **é¢„æœŸç»“æœ**:
   - âœ… èŠå¤©ç•Œé¢åˆ‡æ¢åˆ°è¯¥åŠ©æ‰‹
   - âœ… å·¦ä¾§"è¯é¢˜"æ ‡ç­¾æ˜¾ç¤ºä¸€ä¸ªè‰ç¨¿å¯¹è¯ï¼ˆè™šçº¿è¾¹æ¡†ï¼‰
   - âœ… è¾“å…¥æ¡†å¯ç”¨

#### Test Case 2: Draftä¸­è¾“å…¥æ¶ˆæ¯ï¼ˆæ ¸å¿ƒæµ‹è¯•ï¼ï¼‰

1. ç¡®ä¿å½“å‰åœ¨Draftä¼šè¯
2. è¾“å…¥æ¶ˆæ¯ï¼š"ä½ å¥½"
3. æŒ‰Enterå‘é€
4. **é¢„æœŸç»“æœ**:
   - âœ… **æ¶ˆæ¯ç«‹å³æ˜¾ç¤º**åœ¨èŠå¤©ç•Œé¢ï¼ˆç”¨æˆ·å¤´åƒ + "ä½ å¥½"ï¼‰
   - âœ… é¡¶éƒ¨çŸ­æš‚æ˜¾ç¤º"æ­£åœ¨åˆ›å»ºå¯¹è¯..."æç¤º
   - âœ… **èŠå¤©ç•Œé¢æ— ä»»ä½•åˆ·æ–°æˆ–é—ªçƒ**
   - âœ… å·¦ä¾§Sidebarä»"è‰ç¨¿"å˜ä¸ºæ­£å¼å¯¹è¯
   - âœ… AIå›å¤å¼€å§‹æµå¼è¾“å‡º
   - âœ… å…¨ç¨‹æ¶ˆæ¯å¯è§ï¼Œæ— ä»»ä½•ä¸¢å¤±

#### Test Case 3: ç»§ç»­å¯¹è¯

1. ç»§ç»­è¾“å…¥ç¬¬äºŒæ¡æ¶ˆæ¯ï¼š"è®²ä¸ªç¬‘è¯"
2. æŒ‰Enterå‘é€
3. **é¢„æœŸç»“æœ**:
   - âœ… æ¶ˆæ¯ç«‹å³æ˜¾ç¤º
   - âœ… æ— "æ­£åœ¨åˆ›å»ºå¯¹è¯..."æç¤ºï¼ˆå·²æ˜¯Activeï¼‰
   - âœ… AIæ­£å¸¸å›å¤

#### Test Case 4: åˆ‡æ¢åŠ©æ‰‹å†åˆ›å»ºDraft

1. ç‚¹å‡»å¦ä¸€ä¸ªåŠ©æ‰‹å¡
2. **é¢„æœŸç»“æœ**:
   - âœ… åˆ‡æ¢åˆ°è¯¥åŠ©æ‰‹çš„Draftï¼ˆå¦‚æœå­˜åœ¨ï¼‰
   - âœ… æˆ–åˆ›å»ºæ–°Draftï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
   - âœ… è¾“å…¥æ¡†å¯ç”¨

---

## ğŸ” å…³é”®æ£€æŸ¥ç‚¹

### âœ… æ¶ˆæ¯ä¸ä¸¢å¤±

**æ£€æŸ¥**: Draftå‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯å
- ç”¨æˆ·æ¶ˆæ¯ç«‹å³æ˜¾ç¤º âœ“
- åˆ‡æ¢åˆ°Activeåæ¶ˆæ¯ä»ç„¶æ˜¾ç¤º âœ“
- åˆ·æ–°é¡µé¢åæ¶ˆæ¯å­˜åœ¨ âœ“

### âœ… ç•Œé¢ä¸åˆ·æ–°

**æ£€æŸ¥**: æ•´ä¸ªDraftâ†’Activeè¿‡ç¨‹ä¸­
- èŠå¤©ç•Œé¢æ— ç™½å± âœ“
- èŠå¤©ç•Œé¢æ— é—ªçƒ âœ“
- æ¶ˆæ¯åˆ—è¡¨æ— é‡æ–°æ¸²æŸ“ âœ“
- åªæœ‰Sidebaråˆ·æ–° âœ“

### âœ… çŠ¶æ€æ­£ç¡®

**æ£€æŸ¥**: 
- DraftçŠ¶æ€æ˜¾ç¤º"è‰ç¨¿"æ ‡ç­¾ âœ“
- ActiveçŠ¶æ€æ˜¾ç¤ºæ­£å¸¸ âœ“
- Promotionæ—¶æ˜¾ç¤º"æ­£åœ¨åˆ›å»ºå¯¹è¯..." âœ“

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1: æ¶ˆæ¯å‘é€åæ¶ˆå¤±

**ç—‡çŠ¶**: è¾“å…¥æ¶ˆæ¯æŒ‰Enteråï¼Œæ¶ˆæ¯çŸ­æš‚æ˜¾ç¤ºç„¶åæ¶ˆå¤±

**åŸå› **: derivedMessagesè¢«é‡æ–°åŠ è½½

**æ£€æŸ¥**:
```javascript
// æŸ¥çœ‹æµè§ˆå™¨console
// åº”è¯¥çœ‹åˆ°:
[XState] Draft session detected, triggering promotion...
[XState] Promotion completed, conversation_id: xxx

// ä¸åº”è¯¥çœ‹åˆ°:
[MessageSync] Loading session: xxx (è¿™è¡¨ç¤ºé‡æ–°åŠ è½½äº†)
```

**è§£å†³**: ç¡®è®¤ä½¿ç”¨äº†`useFreeChatWithMachine`è€Œä¸æ˜¯`useFreeChat`

### é—®é¢˜2: "æ­£åœ¨åˆ›å»ºå¯¹è¯..."ä¸€ç›´æ˜¾ç¤º

**ç—‡çŠ¶**: Promotionæç¤ºä¸€ç›´ä¸æ¶ˆå¤±

**åŸå› **: Promotionå¤±è´¥æˆ–è¶…æ—¶

**æ£€æŸ¥**:
```javascript
// æµè§ˆå™¨consoleæŸ¥çœ‹é”™è¯¯
[XState] Promotion failed: ...
```

**è§£å†³**: 
1. æ£€æŸ¥ç½‘ç»œè¯·æ±‚
2. æŸ¥çœ‹backendæ—¥å¿—
3. ç¡®è®¤dialog_idæ­£ç¡®

### é—®é¢˜3: ç‚¹å‡»åŠ©æ‰‹å¡æ— ååº”

**ç—‡çŠ¶**: ç‚¹å‡»åŠ©æ‰‹å¡åèŠå¤©ç•Œé¢ä¸å˜

**åŸå› **: getOrCreateDraftForCardæœªæ­£ç¡®è°ƒç”¨

**æ£€æŸ¥**:
```javascript
// consoleåº”è¯¥çœ‹åˆ°:
[Zustand] Found existing draft for card: xxx
// æˆ–
[Zustand] Creating new draft for card: xxx
```

---

## ğŸ“Š æ€§èƒ½æ£€æŸ¥

### å»¶è¿Ÿæµ‹è¯•

1. æ‰“å¼€Chrome DevTools â†’ Network
2. é™é€Ÿåˆ°"Fast 3G"
3. å‘é€Draftæ¶ˆæ¯
4. **é¢„æœŸ**:
   - æ¶ˆæ¯ç«‹å³æ˜¾ç¤ºï¼ˆä¸å—ç½‘ç»œå½±å“ï¼‰
   - "æ­£åœ¨åˆ›å»ºå¯¹è¯..."æ˜¾ç¤ºæ—¶é—´<1s
   - AIå›å¤å¼€å§‹æ—¶é—´<2s

### å†…å­˜æ£€æŸ¥

1. æ‰“å¼€Chrome DevTools â†’ Performance Monitor
2. è¿ç»­åˆ›å»º10ä¸ªDraft
3. åˆ‡æ¢20æ¬¡ä¼šè¯
4. **é¢„æœŸ**:
   - JS Heapç¨³å®šï¼Œæ— æŒç»­å¢é•¿
   - DOM Nodesç¨³å®š

---

## ğŸ¨ UI/UXæ£€æŸ¥æ¸…å•

- [ ] Draftä¼šè¯æ˜¾ç¤ºè™šçº¿è¾¹æ¡† + "è‰ç¨¿"æ ‡ç­¾
- [ ] Activeä¼šè¯æ˜¾ç¤ºæ­£å¸¸è¾¹æ¡†
- [ ] Promotingæ—¶é¡¶éƒ¨æ˜¾ç¤ºè“è‰²æç¤ºæ¡
- [ ] è¾“å…¥æ¡†åœ¨Promotingæ—¶ç¦ç”¨
- [ ] å‘é€æŒ‰é’®åœ¨Promotingæ—¶æ˜¾ç¤ºloading

---

## ğŸš€ è‡ªåŠ¨åŒ–æµ‹è¯•ï¼ˆæœªæ¥ï¼‰

```typescript
// ç¤ºä¾‹ï¼šè‡ªåŠ¨åŒ–æµ‹è¯•è‰ç¨¿
describe('Draft to Active Transition', () => {
  it('should preserve messages during promotion', async () => {
    // 1. åˆ›å»ºDraft
    const draft = createDraft(modelCardId);
    
    // 2. æ·»åŠ æ¶ˆæ¯
    const message = { content: 'ä½ å¥½' };
    addMessage(message);
    
    // 3. å‘é€æ¶ˆæ¯ï¼ˆè§¦å‘promotionï¼‰
    await sendMessage(message);
    
    // 4. éªŒè¯
    expect(derivedMessages).toContain(message);  // æ¶ˆæ¯ä»ç„¶å­˜åœ¨
    expect(session.state).toBe('active');  // å·²è½¬æ¢ä¸ºActive
    expect(session.conversation_id).toBeDefined();  // æœ‰conversation_id
  });
});
```

---

## ğŸ“ æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

```markdown
## FreeChat XState æµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ—¥æœŸ**: YYYY-MM-DD  
**æµ‹è¯•äºº**: XXX  
**æµè§ˆå™¨**: Chrome/Firefox/Safari  

### æµ‹è¯•ç»“æœ

| æµ‹è¯•é¡¹ | é¢„æœŸ | å®é™… | çŠ¶æ€ |
|--------|------|------|------|
| Draftåˆ›å»º | ç«‹å³åˆ‡æ¢ | - | âœ…/âŒ |
| æ¶ˆæ¯æ˜¾ç¤º | ç«‹å³å¯è§ | - | âœ…/âŒ |
| Draftâ†’Active | æ— åˆ·æ–° | - | âœ…/âŒ |
| AIå›å¤ | æ­£å¸¸æµå¼è¾“å‡º | - | âœ…/âŒ |
| Sidebaræ›´æ–° | Draftâ†’Active | - | âœ…/âŒ |

### å‘ç°çš„é—®é¢˜

1. ...
2. ...

### å»ºè®®

1. ...
```

---

**æµ‹è¯•æ„‰å¿«ï¼** ğŸ‰

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹:
- `SEAMLESS_TRANSITION_IMPLEMENTATION.md` - å®ç°ç»†èŠ‚
- `XSTATE_INTEGRATION_GUIDE.md` - XStateæŒ‡å—
- Browser Console - æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
