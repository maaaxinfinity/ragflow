# ğŸ” æ£€æŸ¥æœåŠ¡å™¨ä»£ç æ˜¯å¦æ›´æ–°

## é—®é¢˜
æœ¬åœ°å·²ä¿®æ”¹ä»£ç è®© Session è®¤è¯å‘é€ beta_tokenï¼Œä½†æœåŠ¡å™¨ä»è¿”å› 401 é”™è¯¯ã€‚

## éœ€è¦æ£€æŸ¥çš„å†…å®¹

### 1. æœåŠ¡å™¨ä¸Šçš„ä»£ç ç‰ˆæœ¬

è¿æ¥åˆ°æœåŠ¡å™¨å¹¶æ£€æŸ¥ï¼š

```bash
# SSH è¿æ¥åˆ°æœåŠ¡å™¨
ssh user@your-server

# æ£€æŸ¥ git çŠ¶æ€
cd /path/to/ragflow
git log --oneline -5

# æŸ¥çœ‹å½“å‰ä»£ç æ˜¯å¦åŒ…å«ä¿®æ”¹
grep -A 10 "Session authentication - get or create beta" api/apps/conversation_app.py
```

**é¢„æœŸç»“æœ**:
- åº”è¯¥èƒ½çœ‹åˆ° commit `266dd3a0`
- ä»£ç ä¸­åº”è¯¥æœ‰ `APIToken.query(tenant_id=current_user.id)`

---

### 2. æœåŠ¡å™¨æ—¥å¿—

æ£€æŸ¥ RAGFlow æ—¥å¿—ï¼š

```bash
# Docker éƒ¨ç½²
docker logs ragflow-server --tail 100 | grep -i modelcards

# PM2 éƒ¨ç½²
pm2 logs ragflow --lines 100 | grep -i modelcards

# Systemd éƒ¨ç½²
journalctl -u ragflow -n 100 | grep -i modelcards
```

**é¢„æœŸæ—¥å¿—**:
```
[ModelCards] Using existing beta_token for session user
æˆ–
[ModelCards] Created new beta_token for session user: ragflow-xxxxx
```

**å¦‚æœçœ‹åˆ°**:
```
[ModelCards] Using access_token from session auth
```
è¯´æ˜**ä»£ç è¿˜æ˜¯æ—§ç‰ˆæœ¬**ï¼

---

### 3. æ•°æ®åº“æ£€æŸ¥

è¿æ¥åˆ°æœåŠ¡å™¨å¹¶æ£€æŸ¥ APIToken è¡¨ï¼š

```bash
# è¿›å…¥ MySQL å®¹å™¨
docker exec -it ragflow-mysql mysql -u root -pinfini_rag_flow rag_flow

# æˆ–ç›´æ¥æ‰§è¡ŒæŸ¥è¯¢
docker exec -it ragflow-mysql mysql -u root -pinfini_rag_flow rag_flow \
  -e "SELECT id, tenant_id, beta, create_time FROM api_token ORDER BY create_time DESC LIMIT 5;"
```

**é¢„æœŸç»“æœ**:
- åº”è¯¥èƒ½çœ‹åˆ°ç”¨æˆ·çš„ beta_tokenï¼ˆæ ¼å¼ï¼š`ragflow-xxxxxxxxx`ï¼‰

**å¦‚æœè¡¨æ˜¯ç©ºçš„**:
- è¯´æ˜ä»£ç è¿˜æ²¡æ‰§è¡Œåˆ°åˆ›å»º beta_token çš„é€»è¾‘
- æˆ–è€…ä»£ç æ ¹æœ¬æ²¡æœ‰æ›´æ–°

---

### 4. æµ‹è¯•å½“å‰ä»£ç è¡Œä¸º

ç”¨ä½ çš„ curl å‘½ä»¤æµ‹è¯•ï¼ŒåŒæ—¶ç›‘æ§æ—¥å¿—ï¼š

**ç»ˆç«¯ 1ï¼ˆç›‘æ§æ—¥å¿—ï¼‰**:
```bash
docker logs ragflow-server -f | grep -i modelcards
```

**ç»ˆç«¯ 2ï¼ˆå‘é€è¯·æ±‚ï¼‰**:
```bash
curl 'https://rag.limitee.cn/v1/conversation/model_cards' \
  -H 'authorization: Bearer Q4OTk4ODM2OWVjNTExZjBiMTA2ZjY4YT' \
  -b 'session=T4-G_4v4U7d1_ELt7qSWF5vXocLUFg4st1oqHY9e0t0'
```

**è§‚å¯Ÿæ—¥å¿—è¾“å‡º**:
- å¦‚æœçœ‹åˆ° `Using access_token` â†’ ä»£ç æœªæ›´æ–°
- å¦‚æœçœ‹åˆ° `Using existing beta_token` â†’ ä»£ç å·²æ›´æ–°ï¼Œä½†å¯èƒ½ law-workspace çš„éªŒè¯æœ‰é—®é¢˜
- å¦‚æœçœ‹åˆ° `Created new beta_token` â†’ ä»£ç å·²æ›´æ–°ï¼Œæ­£åœ¨åˆ›å»º token

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤ï¼ˆå¦‚æœä»£ç æœªæ›´æ–°ï¼‰

### æ–¹æ¡ˆ A: Git Pull + é‡å¯

```bash
# 1. è¿›å…¥ RAGFlow ç›®å½•
cd /path/to/ragflow

# 2. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 3. ç¡®è®¤ commit
git log --oneline -1
# åº”è¯¥çœ‹åˆ°: 266dd3a0 fix: ä¿®å¤æ¨¡å‹å¡ç‰‡102é”™è¯¯ - Sessionè®¤è¯ä½¿ç”¨beta_token

# 4. é‡å¯æœåŠ¡
# Docker
cd docker
docker-compose restart ragflow

# PM2
pm2 restart ragflow

# Systemd
sudo systemctl restart ragflow
```

### æ–¹æ¡ˆ B: æ‰‹åŠ¨æ›´æ–°ä»£ç æ–‡ä»¶

å¦‚æœæ— æ³• git pullï¼Œæ‰‹åŠ¨å¤åˆ¶æ–‡ä»¶ï¼š

**æœ¬åœ°**:
```bash
cd D:\workspace\ragflow
scp api/apps/conversation_app.py user@server:/path/to/ragflow/api/apps/
```

**æœåŠ¡å™¨**:
```bash
# é‡å¯æœåŠ¡
docker-compose restart ragflow
```

### æ–¹æ¡ˆ C: æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–åˆ†æ”¯

```bash
# æŸ¥çœ‹å½“å‰åˆ†æ”¯
git branch

# æŸ¥çœ‹æ‰€æœ‰åˆ†æ”¯
git branch -a

# å¦‚æœä¸åœ¨ main åˆ†æ”¯
git checkout main
git pull origin main

# é‡å¯æœåŠ¡
docker-compose restart ragflow
```

---

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜ 1: Git pull æç¤ºå†²çª

```bash
# æŸ¥çœ‹å†²çªæ–‡ä»¶
git status

# æš‚å­˜æœ¬åœ°ä¿®æ”¹
git stash

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# æ¢å¤æœ¬åœ°ä¿®æ”¹ï¼ˆå¦‚æœéœ€è¦ï¼‰
git stash pop
```

### é—®é¢˜ 2: Docker å®¹å™¨å†…ä»£ç æœªæ›´æ–°

å¯èƒ½æ˜¯ä»£ç æŒ‚è½½é—®é¢˜ï¼š

```bash
# æ£€æŸ¥ docker-compose.yml çš„ volumes é…ç½®
cat docker/docker-compose.yml | grep -A 5 "volumes:"

# å¦‚æœä»£ç æ˜¯æŒ‚è½½è¿›å»çš„
# é‡å¯å®¹å™¨å³å¯
docker-compose restart ragflow

# å¦‚æœä»£ç æ˜¯æ‰“åŒ…åœ¨é•œåƒé‡Œ
# éœ€è¦é‡æ–°æ„å»ºé•œåƒ
docker-compose down
docker-compose build ragflow
docker-compose up -d
```

### é—®é¢˜ 3: é‡å¯åä»æ˜¯æ—§ä»£ç 

```bash
# ç¡®è®¤å®¹å™¨å†…çš„ä»£ç 
docker exec -it ragflow-server cat /ragflow/api/apps/conversation_app.py | grep -A 5 "Session authentication"

# å¦‚æœä»æ˜¯æ—§ä»£ç ï¼Œå¯èƒ½éœ€è¦æ¸…ç†å®¹å™¨
docker-compose down
docker-compose up -d
```

---

## ğŸ“‹ å¿«é€Ÿè¯Šæ–­æ¸…å•

- [ ] æœåŠ¡å™¨ä»£ç æ˜¯å¦æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Ÿï¼ˆæ£€æŸ¥ git logï¼‰
- [ ] ä»£ç ä¸­æ˜¯å¦åŒ…å« `APIToken.query(tenant_id=current_user.id)`ï¼Ÿ
- [ ] æœåŠ¡æ˜¯å¦å·²é‡å¯ï¼Ÿï¼ˆæ£€æŸ¥å®¹å™¨/è¿›ç¨‹å¯åŠ¨æ—¶é—´ï¼‰
- [ ] æ—¥å¿—ä¸­æ˜¯å¦æœ‰ `Using existing beta_token` æˆ– `Created new beta_token`ï¼Ÿ
- [ ] APIToken è¡¨ä¸­æ˜¯å¦æœ‰ç”¨æˆ·çš„ beta_tokenï¼Ÿ
- [ ] law-workspace æ˜¯å¦ä¹Ÿå·²é‡å¯ï¼Ÿ

---

## ğŸ’¡ è°ƒè¯•å»ºè®®

### æœ€å°åŒ–æµ‹è¯•

1. **å…ˆæµ‹è¯• RAGFlow æœ¬åœ°**:
```bash
# ç›´æ¥è®¿é—® RAGFlow çš„ model_cards ç«¯ç‚¹
curl https://rag.limitee.cn/v1/conversation/model_cards \
  -H "Authorization: Bearer Q4OTk4ODM2OWVjNTExZjBiMTA2ZjY4YT" \
  -b "session=T4-G_4v4U7d1_ELt7qSWF5vXocLUFg4st1oqHY9e0t0" \
  -v
```

2. **æ£€æŸ¥ RAGFlow å‘é€äº†ä»€ä¹ˆ token**:
```bash
# åœ¨ law-workspace çš„ model-cards API ä¸­æ·»åŠ æ—¥å¿—
console.log('[model-cards] Received token:', authToken);
console.log('[model-cards] Token type:', authToken.startsWith('ragflow-') ? 'beta_token' : 'access_token');
```

3. **æ£€æŸ¥ token æ˜¯å¦èƒ½é€šè¿‡éªŒè¯**:
```bash
# ç›´æ¥æµ‹è¯• /user/info
curl https://rag.limitee.cn/v1/user/info \
  -H "Authorization: Bearer ragflow-xxxxx"  # ç”¨å®é™…çš„ beta_token
```

---

## ğŸ¯ é¢„æœŸè¡Œä¸ºï¼ˆä¿®å¤åï¼‰

**è¯·æ±‚æµç¨‹**:
```
æµè§ˆå™¨ â†’ RAGFlow /model_cards
  â†“ (Session è®¤è¯)
  â†“ æŸ¥è¯¢ APIToken â†’ è·å– beta_token
  â†“
  â†’ law-workspace /api/model-cards
    Authorization: Bearer ragflow-xxxxx
    â†“
    â†’ RAGFlow /user/info
      Authorization: Bearer ragflow-xxxxx
      â†“
      âœ… éªŒè¯é€šè¿‡ â†’ è¿”å›ç”¨æˆ·ä¿¡æ¯
    â†“
    è¿”å›æ¨¡å‹å¡ç‰‡åˆ—è¡¨
```

**æ—¥å¿—è¾“å‡º**:
```
[RAGFlow] [ModelCards] Using existing beta_token for session user
[law-workspace] [model-cards] Authorized request from: user@example.com
[law-workspace] [model-cards] Found 3 active model cards
```

**å“åº”**:
```json
{
  "code": 0,
  "data": [
    {
      "id": 1,
      "name": "æ³•å¾‹åŠ©æ‰‹Pro",
      "bot_id": "xxx",
      "temperature": 0.3
    }
  ]
}
```

---

**å…³é”®**: å¿…é¡»ç¡®è®¤æœåŠ¡å™¨ä¸Šçš„ä»£ç å·²æ›´æ–°å¹¶é‡å¯ï¼
