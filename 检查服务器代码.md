# 🔍 检查服务器代码是否更新

## 问题
本地已修改代码让 Session 认证发送 beta_token，但服务器仍返回 401 错误。

## 需要检查的内容

### 1. 服务器上的代码版本

连接到服务器并检查：

```bash
# SSH 连接到服务器
ssh user@your-server

# 检查 git 状态
cd /path/to/ragflow
git log --oneline -5

# 查看当前代码是否包含修改
grep -A 10 "Session authentication - get or create beta" api/apps/conversation_app.py
```

**预期结果**:
- 应该能看到 commit `266dd3a0`
- 代码中应该有 `APIToken.query(tenant_id=current_user.id)`

---

### 2. 服务器日志

检查 RAGFlow 日志：

```bash
# Docker 部署
docker logs ragflow-server --tail 100 | grep -i modelcards

# PM2 部署
pm2 logs ragflow --lines 100 | grep -i modelcards

# Systemd 部署
journalctl -u ragflow -n 100 | grep -i modelcards
```

**预期日志**:
```
[ModelCards] Using existing beta_token for session user
或
[ModelCards] Created new beta_token for session user: ragflow-xxxxx
```

**如果看到**:
```
[ModelCards] Using access_token from session auth
```
说明**代码还是旧版本**！

---

### 3. 数据库检查

连接到服务器并检查 APIToken 表：

```bash
# 进入 MySQL 容器
docker exec -it ragflow-mysql mysql -u root -pinfini_rag_flow rag_flow

# 或直接执行查询
docker exec -it ragflow-mysql mysql -u root -pinfini_rag_flow rag_flow \
  -e "SELECT id, tenant_id, beta, create_time FROM api_token ORDER BY create_time DESC LIMIT 5;"
```

**预期结果**:
- 应该能看到用户的 beta_token（格式：`ragflow-xxxxxxxxx`）

**如果表是空的**:
- 说明代码还没执行到创建 beta_token 的逻辑
- 或者代码根本没有更新

---

### 4. 测试当前代码行为

用你的 curl 命令测试，同时监控日志：

**终端 1（监控日志）**:
```bash
docker logs ragflow-server -f | grep -i modelcards
```

**终端 2（发送请求）**:
```bash
curl 'https://rag.limitee.cn/v1/conversation/model_cards' \
  -H 'authorization: Bearer Q4OTk4ODM2OWVjNTExZjBiMTA2ZjY4YT' \
  -b 'session=T4-G_4v4U7d1_ELt7qSWF5vXocLUFg4st1oqHY9e0t0'
```

**观察日志输出**:
- 如果看到 `Using access_token` → 代码未更新
- 如果看到 `Using existing beta_token` → 代码已更新，但可能 law-workspace 的验证有问题
- 如果看到 `Created new beta_token` → 代码已更新，正在创建 token

---

## 🚀 部署步骤（如果代码未更新）

### 方案 A: Git Pull + 重启

```bash
# 1. 进入 RAGFlow 目录
cd /path/to/ragflow

# 2. 拉取最新代码
git pull origin main

# 3. 确认 commit
git log --oneline -1
# 应该看到: 266dd3a0 fix: 修复模型卡片102错误 - Session认证使用beta_token

# 4. 重启服务
# Docker
cd docker
docker-compose restart ragflow

# PM2
pm2 restart ragflow

# Systemd
sudo systemctl restart ragflow
```

### 方案 B: 手动更新代码文件

如果无法 git pull，手动复制文件：

**本地**:
```bash
cd D:\workspace\ragflow
scp api/apps/conversation_app.py user@server:/path/to/ragflow/api/apps/
```

**服务器**:
```bash
# 重启服务
docker-compose restart ragflow
```

### 方案 C: 检查是否有其他分支

```bash
# 查看当前分支
git branch

# 查看所有分支
git branch -a

# 如果不在 main 分支
git checkout main
git pull origin main

# 重启服务
docker-compose restart ragflow
```

---

## 🐛 常见问题

### 问题 1: Git pull 提示冲突

```bash
# 查看冲突文件
git status

# 暂存本地修改
git stash

# 拉取最新代码
git pull origin main

# 恢复本地修改（如果需要）
git stash pop
```

### 问题 2: Docker 容器内代码未更新

可能是代码挂载问题：

```bash
# 检查 docker-compose.yml 的 volumes 配置
cat docker/docker-compose.yml | grep -A 5 "volumes:"

# 如果代码是挂载进去的
# 重启容器即可
docker-compose restart ragflow

# 如果代码是打包在镜像里
# 需要重新构建镜像
docker-compose down
docker-compose build ragflow
docker-compose up -d
```

### 问题 3: 重启后仍是旧代码

```bash
# 确认容器内的代码
docker exec -it ragflow-server cat /ragflow/api/apps/conversation_app.py | grep -A 5 "Session authentication"

# 如果仍是旧代码，可能需要清理容器
docker-compose down
docker-compose up -d
```

---

## 📋 快速诊断清单

- [ ] 服务器代码是否是最新版本？（检查 git log）
- [ ] 代码中是否包含 `APIToken.query(tenant_id=current_user.id)`？
- [ ] 服务是否已重启？（检查容器/进程启动时间）
- [ ] 日志中是否有 `Using existing beta_token` 或 `Created new beta_token`？
- [ ] APIToken 表中是否有用户的 beta_token？
- [ ] law-workspace 是否也已重启？

---

## 💡 调试建议

### 最小化测试

1. **先测试 RAGFlow 本地**:
```bash
# 直接访问 RAGFlow 的 model_cards 端点
curl https://rag.limitee.cn/v1/conversation/model_cards \
  -H "Authorization: Bearer Q4OTk4ODM2OWVjNTExZjBiMTA2ZjY4YT" \
  -b "session=T4-G_4v4U7d1_ELt7qSWF5vXocLUFg4st1oqHY9e0t0" \
  -v
```

2. **检查 RAGFlow 发送了什么 token**:
```bash
# 在 law-workspace 的 model-cards API 中添加日志
console.log('[model-cards] Received token:', authToken);
console.log('[model-cards] Token type:', authToken.startsWith('ragflow-') ? 'beta_token' : 'access_token');
```

3. **检查 token 是否能通过验证**:
```bash
# 直接测试 /user/info
curl https://rag.limitee.cn/v1/user/info \
  -H "Authorization: Bearer ragflow-xxxxx"  # 用实际的 beta_token
```

---

## 🎯 预期行为（修复后）

**请求流程**:
```
浏览器 → RAGFlow /model_cards
  ↓ (Session 认证)
  ↓ 查询 APIToken → 获取 beta_token
  ↓
  → law-workspace /api/model-cards
    Authorization: Bearer ragflow-xxxxx
    ↓
    → RAGFlow /user/info
      Authorization: Bearer ragflow-xxxxx
      ↓
      ✅ 验证通过 → 返回用户信息
    ↓
    返回模型卡片列表
```

**日志输出**:
```
[RAGFlow] [ModelCards] Using existing beta_token for session user
[law-workspace] [model-cards] Authorized request from: user@example.com
[law-workspace] [model-cards] Found 3 active model cards
```

**响应**:
```json
{
  "code": 0,
  "data": [
    {
      "id": 1,
      "name": "法律助手Pro",
      "bot_id": "xxx",
      "temperature": 0.3
    }
  ]
}
```

---

**关键**: 必须确认服务器上的代码已更新并重启！
